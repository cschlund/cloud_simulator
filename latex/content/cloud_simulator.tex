
%\section{Description of the cloud simulator}\label{simpsimu}

This section describes the main steps of retrieving monthly mean 
Cloud\_cci-like (i.e. pseudo-satellite) observations derived from 
global atmospheric reanalysis produced by ECMWF.
The clouds simulator reads the 6-hourly (00, 06, 12, 18 UTC) 
ERA-Interim files per month containing gridbox mean vertical profiles of
\begin{itemize}
    \setlength\itemsep{0.2em}
    \item pressure level $P_{lev}$ [Pa],
    \item liquid water content $LWC$ [kg/kg]$\footnote{mass of condensate per mass of moist air}$,
    \item ice water content $IWC$ [kg/kg],
    \item cloud cover $CC$ (0-1),
    \item geopotential height $h_{geo}$ [m$^{2}/s^{2}$], and
    \item temperature $T$ [K].
\end{itemize}
A detailed description of the ERA-Interim data is given in section~\ref{sec:era}.
The following steps address the things needed to simulate the observational process.
In other words, what would a satellite see if the atmosphere had the clouds
of a climate model?


%\subsection{Calculation of cloud effective radius, optical thickness and water path}
\subsection{Pre-processing}

In the first step the gridbox mean liquid and ice water contents at each model level
are weighted by the cloud cover profile providing the so-called 
``in-cloud'' liquid and ice water contents. 
Thus, only the cloudy part of the grid cell is taken into account, 
which is comparable to what a satellite would detect.
Based on these cloud-cover-weighted profiles the liquid ($LWP$) and ice ($IWP$) water paths
per model layer can be derived, which present the total amount of liquid and ice
water between two consecutive pressure levels in the atmosphere, respectively.
The total amount of $LWP$ and $IWP$ is referred to as cloud water path ($CWP$).

The cloud optical thickness ($\tau$) per layer is obtained by the method of \citet{Han1994}
\begin{equation}\label{eq:han}
    \tau = \frac{3}{4} \frac{CWP \cdot  Q_{ext}}{r_{e} \cdot \rho}
\end{equation}
where $CWP$ represents either $LWP$ or $IWP$ depending on the thermodynamic phase.
$Q_{ext}$ denotes the extinction coefficient, which is assumed to be 2 for water and 2.1 for ice.
The density $\rho$ is set to 1 $g/m^{3}$ for water and 0.9167 $g/m^{3}$ for ice.
For the computation of effective radii ($r_{e}$) per layer the 
ERA-Interim parameterizations are implemented in the cloud simulator.

The cloud droplet effective radius ($r_{e}^{liq}$) follows the method of \citet{Martin1994} and 
is defined as function of liquid water content and cloud droplet number 
concentration, which in turn depends on the wind speed.
For practical reasons the simulator uses constant values for the number of 
cloud condensation nuclei over land (300) and sea (100).
Hence, a land-sea mask (Fig.~\ref{fig:lsm}) is required, 
which is obtained from ERA-Interim Sea Surface Temperature (Fig.~\ref{fig:sst}) 
data aggregated on a 0.5$^{\circ}$ latitude-longitude grid.
The ice crystal effective radius ($r_{e}^{ice}$) is parameterized as a function of 
temperature and ice water content based on \citet{Sun1999}, which has been
revised by \citet{Sun2001}.

In CC4CL the simultaneously retrieved $\tau^{liq}$ ($\tau^{ice}$) and 
$r_{e}^{liq}$ ($r_{e}^{ice}$) are combined utilizing the relationship given in 
Eq.~\ref{eq:han} for deriving $LWP$ ($IWP$) as post-processed product.
Thus, the cloud simulator adopts this retrieval characteristic of CC4CL by
using this equation for computing the 
cloud optical thickness per model layer since ERA-Interim provides solely 
the information on the cloud water content and cloud amount.

%\captionsetup[subfloat]{position=top}
\begin{figure}[!h]
  \begin{minipage}[t]{0.5\textwidth}
    \subfloat[ERA-Interim land-sea mask (LSM).]
    {\includegraphics[scale=0.26]{./figures/{lsm_era_interim_0.5_0.5}.png}\label{fig:lsm}}
  \end{minipage}
  \begin{minipage}[t]{0.5\textwidth}
    \subfloat[ERA-Interim sea surface temperature (SST).]
    {\includegraphics[scale=0.26]{./figures/{sst_era_interim_0.5_0.5}.png}\label{fig:sst}}
  \end{minipage}
  \caption[ERA-Interim land-sea mask and sea surface temperature (31/08/2015).]
{ERA-Interim auxiliary data provided on a 0.5$^{\circ}$ latitude-longitude grid.}\label{fig:lsm_sst}
\end{figure}


\subsection{Downscaler}
In the next step the simulator has to adress the mismatch in scale between 
that of a ERA-Interim model grid box ($\sim$ 500 km) and 
that of a satellite footprint ($\sim$ 5 km, e.g. AVHRR).
This is achieved by scaling the grid box mean profiles (e.g., 
Fig.~\ref{fig:profiles}) for each grid cell down to subcolumns$\footnote{
Currently each grid cell is broken into 20 subcolumns. This will be changed 
so that the number of subcolumns will be a function of latitude.}$, which
can be thought of as respresenting the spatial resolution of the instrument.

Figure~\ref{fig:scops} shows examples of vertical profiles of individual subcolumns 
based on the grid box mean profiles displayed in Figure~\ref{fig:profiles}.
For instance, Figure~\ref{fig:cfc_scops} illustrates an ensemble of 
subgrid cloud fraction profiles representing the cloud distribution 
within the model grid box shown in Figure~\ref{fig:cfc_profile} for the grid cell 
located at N$31^{\circ}30^{\prime}$ and E$164^{\circ}0^{\prime}$.
A pseudo-random sampling process takes the vertical profile of the cloud
fraction and generates horizontally homogeneous subgrid profiles.
Then, each grid column is split into subcolumns in which each layer is either
completely cloudy (1) or clear (0) assuming maximum random cloud overlap, i.e.
clouds in neighboring layers are maximally overlapped, while groups of clouds 
separated by one or more clear layers are randomly overlapped.

%Each cloud subcolumn gets COT and CWP grid box value.
The cloud optical thickness (Fig.~\ref{fig:cot_profile}) and
cloud water path (Fig.~\ref{fig:cwp_profile}) 
%CER is a weighted product
%CPH is the cloud liquid fraction.

The used approach for deriving subgrid profiles is very similar to
SCOPS (Subgrid Cloud Overlap Profile Sampler, \citet{Webb2001}),
which is implemented, for instance, in COSP (CFMIP Observation Simulator
Package, \cite{Bodas2011}).
COSP is an integrated satellite simulator, which has been developed by 
the Cloud Feedback Model Intercomparison Project (CFMIP) community.
It is capable to simulate observations of multiple active and passive
satellite instruments (e.g., CloudSat, Calipso, ISCCP, MISR, MODIS, RTTOV) 
and therefore, allows the quantitative evaluation of clouds, humidity,
and precipitation processes in diverse numerical models.


% grid box mean profiles 
\begin{figure}[!h]
  \centering
  \begin{minipage}{0.3\textwidth}
    \subfloat[Cloud fraction.]
    {\includegraphics[scale=0.17]{./figures/\snapscops_CFC9_profile.png}
    \label{fig:cfc_profile}}
  \end{minipage}\hfill
  \begin{minipage}{0.3\textwidth}
    \subfloat[Cloud optical thickness.]
    {\includegraphics[scale=0.17]{./figures/\snapscops_COT9_profile.png}
    \label{fig:cot_profile}}
  \end{minipage}\hfill
  \begin{minipage}{0.3\textwidth}
    \subfloat[Cloud water path.]
    {\includegraphics[scale=0.17]{./figures/\snapscops_CWP9_profile.png}
    \label{fig:cwp_profile}}
  \end{minipage}
  \caption[Grid box mean profiles.]{Example of (a) cloud fraction,
      (b) cloud optical thickness, and (c) cloud water path 
      grid box mean profiles. The daytime grid cell is located
      at N$31^{\circ}30^{\prime}$ and E$164^{\circ}0^{\prime}$ 
  at UTC 00 on 1$^{st}$ of \MonthYear.}
  \label{fig:profiles}
\end{figure}


% subcolumn cloud distribution 
\begin{figure}[!h]

  \begin{minipage}[c][4.5cm][c]{\textwidth}

    \begin{minipage}{0.3\textwidth}
      \subfloat[Cloud fraction.]
      {\includegraphics[scale=0.17]{./figures/\snapscops_CFC9.png}
      \label{fig:cfc_scops}}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
      \subfloat[Cloud optical thickness.]
      {\includegraphics[scale=0.17]{./figures/\snapscops_COT9.png}
      \label{fig:cot_scops}}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
      \subfloat[Cloud water path.]
      {\includegraphics[scale=0.17]{./figures/\snapscops_CWP9.png}
      \label{fig:cwp_scops}}
    \end{minipage}

  \end{minipage}
  \begin{minipage}[c][4.5cm][c]{\textwidth}

    \begin{minipage}{0.3\textwidth}
        \begin{minipage}[c]{0.9\textwidth}
        Grid cell location: \\
        N$31^{\circ}30^{\prime}$ E$164^{\circ}0^{\prime}$\\
        Solar zenith angle is 17.7
        \end{minipage}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
      \subfloat[Cloud effective radius.]
      {\includegraphics[scale=0.17]{./figures/\snapscops_CER9.png}
      \label{fig:cer_scops}}
    \end{minipage}\hfill
    \begin{minipage}{0.3\textwidth}
      \subfloat[Cloud phase.]
      {\includegraphics[scale=0.17]{./figures/\snapscops_CPH9.png}
      \label{fig:cph_scops}}
    \end{minipage}

  \end{minipage}
  \caption[Down-scaled cloud parameter profiles.]{Subgrid profiles 
      of (a) cloud fraction, (b) cloud optical thickness, (c) cloud water path,
      (d) cloud effective radius, and (e) cloud phase
      derived from grid box mean profiles shown in Figure~\ref{fig:profiles} 
  at UTC 00 on 1$^{st}$ of \MonthYear.}
  \label{fig:scops}
\end{figure}


%2. search for upper-most cloud and collect cloud parameters
\subsection{Pseudo-retrieval}
operate on subcolumns
%In the previous section the pre-processing of pseudo-satellite 
%$\tau$, $r_{e}$, and $CWP$ vertical profiles has been explained,
%which complement along with the original ERA-Interim 3D fields the required
%input data for the pseudo retrieval.
%This is the essential part of the cloud simulator responsible for producing 
%output comparable to Cloud\_cci data in three main steps.
%Scale COT greater than 100.
%Only solar COT, CWP, CER due to CC4CL.


% cloud top parameters 
\begin{figure}[!h]
  \begin{minipage}{\textwidth}
    \subfloat[Grid cell at N$29^{\circ}30^{\prime}$ and E$162^{\circ}30^{\prime}$.]
    {\includegraphics[width=\textwidth]{./figures/\snapscops_retrieved1.png}}
  \end{minipage}\vspace*{0.5cm}
  \begin{minipage}{\textwidth}
    \subfloat[Grid cell at N$31^{\circ}30^{\prime}$ and E$164^{\circ}0^{\prime}$.]
    {\includegraphics[width=\textwidth]{./figures/\snapscops_retrieved9.png}}
  \end{minipage}
  \caption[Retrieved subcolumn cloud top parameters.]
{Retrieved subcolumn cloud fraction (CFC), cloud top pressure (CTP),
cloud top temperature (CTT), cloud top height (CTH),
cloud phase (CPH), cloud effective radius (CER),
cloud optical thickness (COT), and cloud water path (CWP) 
for two different grid boxes at UTC 00 on 1$^{st}$ of \MonthYear.}
\label{fig:retrieved}
\end{figure}



%3. collect statistics, i.e. means over subcolumns and 1D, 2D histograms
\subsection{Compute summary statistics}


%% CER, CWP, COT only daytime
%\begin{figure}[!h]
%  \begin{minipage}[c]{0.5\textwidth}
%    \includegraphics[scale=0.27]{./figures/{\szamidnight}.png}
%    \includegraphics[scale=0.27]{./figures/{\szamidday}.png}
%  \end{minipage}\hfill
%  \begin{minipage}[c]{0.5\textwidth}
%    \includegraphics[scale=0.27]{./figures/{\szamorning}.png}
%    \includegraphics[scale=0.27]{./figures/{\szaevening}.png}
%  \end{minipage}
%  \caption[Solar zenith angle for 00, 06, 12, 18 UTC.]
%  {Solar zenith angle maps for 00, 06, 12, and 18 UTC on 1$^{st}$ of \MonthYear.} 
%  \label{fig:sza}
%\end{figure}
%
%


